<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gesture Synth</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{background:#000011;overflow:hidden;font-family:'Segoe UI',system-ui,-apple-system,sans-serif;color:#fff;width:100vw;height:100vh}
    #three-canvas{position:fixed;top:0;left:0;width:100%;height:100%;z-index:1}
    #webcam{position:fixed;top:0;left:0;width:1px;height:1px;opacity:0;pointer-events:none}
    #hand-canvas{position:fixed;top:0;left:0;width:100%;height:100%;z-index:5;pointer-events:none}
    #start-overlay{position:fixed;inset:0;z-index:100;display:flex;flex-direction:column;align-items:center;justify-content:center;background:radial-gradient(ellipse at center,#0a0a2e 0%,#000011 70%)}
    #start-overlay h1{font-size:3rem;font-weight:200;letter-spacing:.3em;text-transform:uppercase;margin-bottom:.5rem;background:linear-gradient(135deg,#00ffd5,#7b61ff);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .subtitle{font-size:1rem;color:rgba(255,255,255,.4);margin-bottom:1.5rem;letter-spacing:.1em}
    .hint{font-size:.7rem;color:rgba(255,255,255,.2);margin-bottom:2.5rem;letter-spacing:.03em;max-width:420px;text-align:center;line-height:1.8}
    .hint b{color:rgba(0,255,200,.5);font-weight:400}
    #start-btn{padding:16px 48px;font-size:1.1rem;letter-spacing:.15em;text-transform:uppercase;border:1px solid rgba(0,255,200,.4);background:rgba(0,255,200,.05);color:#00ffd5;border-radius:60px;cursor:pointer;transition:all .3s ease}
    #start-btn:hover{background:rgba(0,255,200,.15);border-color:rgba(0,255,200,.8);box-shadow:0 0 30px rgba(0,255,200,.2)}
    #hud{position:fixed;top:20px;left:20px;z-index:10;display:none;font-size:.63rem;letter-spacing:.04em;color:rgba(255,255,255,.25)}
    .hud-s{margin-bottom:10px}.hud-label{text-transform:uppercase;font-size:.52rem;color:rgba(255,255,255,.16);margin-bottom:3px}
    .hud-row{margin-bottom:2px}.hud-row span{color:rgba(0,255,200,.6)}
    .hud-bar{width:90px;height:2px;background:rgba(255,255,255,.06);border-radius:1px;margin-top:2px}
    .hud-bar-fill{height:100%;width:0%;border-radius:1px;transition:width .1s ease}
    .fill-v{background:linear-gradient(90deg,#7b61ff,#00ffd5)}.fill-a{background:linear-gradient(90deg,#ff6b9d,#ffaa40)}
    #layers{display:flex;gap:4px;margin-top:5px;flex-wrap:wrap;max-width:200px}
    .ld{font-size:.48rem;text-transform:uppercase;letter-spacing:.02em;padding:1px 5px;border-radius:3px;background:rgba(255,255,255,.03);color:rgba(255,255,255,.1);transition:all .3s ease}
    .ld.on{background:rgba(0,255,200,.12);color:rgba(0,255,200,.85);box-shadow:0 0 6px rgba(0,255,200,.12)}
    .ld.fx{background:rgba(255,100,50,.1);color:rgba(255,100,50,.7)}
    .gt{display:inline-block;font-size:.48rem;padding:1px 4px;border-radius:2px;margin-left:3px;background:rgba(255,100,200,.12);color:rgba(255,100,200,.6);opacity:0;transition:opacity .2s ease}
    .gt.on{opacity:1}
    .fmap{font-size:.46rem;color:rgba(255,255,255,.12);margin-top:3px;letter-spacing:.02em}.fmap b{color:rgba(0,255,200,.3);font-weight:400}
    #instructions{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);z-index:10;text-align:center;font-size:.72rem;color:rgba(255,255,255,.38);letter-spacing:.03em;padding:10px 20px;background:rgba(0,0,0,.4);border-radius:30px;backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.06);opacity:0;transition:opacity 1s ease;pointer-events:none}
    #loading-msg{position:fixed;inset:0;z-index:50;display:none;flex-direction:column;align-items:center;justify-content:center;background:#000011;gap:16px}
    #loading-msg p{color:rgba(255,255,255,.5);font-size:.9rem;letter-spacing:.08em}
    .spinner{width:32px;height:32px;border:2px solid rgba(0,255,200,.15);border-top-color:#00ffd5;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    #error-msg{position:fixed;inset:0;z-index:200;display:none;flex-direction:column;align-items:center;justify-content:center;background:#000011;gap:12px}
    #error-msg p{color:rgba(255,100,100,.8);font-size:1rem;text-align:center;max-width:400px;line-height:1.6}
  </style>
</head>
<body>
  <div id="start-overlay">
    <h1>Gesture Synth</h1>
    <p class="subtitle">dual-hand audiovisual instrument</p>
    <p class="hint">
      <b>Right hand</b> — each finger is a track:<br>
      Thumb=Overdrive &middot; Index=Drums &middot; Middle=Bass &middot; Ring=Pad &middot; Pinky=Texture<br><br>
      <b>Left hand</b> — shapes the visual world<br>
      Open/close for intensity &middot; Twist to shift colors<br>
      Snap open for supernova &middot; All 5 for maximum mode<br><br>
      <b>Snap fingers</b> — time freeze<br>
      <b>Bring hands together</b> — energy orb forms between palms<br>
      <b>Slam orb</b> — detonates and changes the song<br><br>
      L-pinch = gravity warp &middot; R-pinch = tension drop<br>
      Grab artifacts &middot; Move fast = glitch &middot; Spread = reverb
    </p>
    <button id="start-btn">Enter</button>
  </div>
  <div id="loading-msg"><div class="spinner"></div><p>Initializing hand tracking...</p></div>
  <div id="error-msg"><p id="error-text"></p></div>
  <canvas id="three-canvas"></canvas>
  <video id="webcam" autoplay playsinline></video>
  <canvas id="hand-canvas"></canvas>
  <div id="hud">
    <div class="hud-s">
      <div class="hud-label">Left / Visuals</div>
      <div class="hud-row">State: <span id="hl-s">--</span>
        <span class="gt" id="gt-lp">warp</span><span class="gt" id="gt-lv">burst</span><span class="gt" id="gt-nova">nova</span></div>
      <div class="hud-row">Fingers: <span id="hl-f">-</span></div>
      <div class="hud-bar"><div class="hud-bar-fill fill-v" id="hl-b"></div></div>
    </div>
    <div class="hud-s">
      <div class="hud-label">Right / Audio</div>
      <div class="hud-row">State: <span id="hr-s">--</span>
        <span class="gt" id="gt-rp">riser</span><span class="gt" id="gt-rv">stutter</span></div>
      <div id="layers">
        <span class="ld" id="ld-fx">OD</span>
        <span class="ld" id="ld-drum">drum</span>
        <span class="ld" id="ld-bass">bass</span>
        <span class="ld" id="ld-pad">pad</span>
        <span class="ld" id="ld-tex">tex</span>
      </div>
      <div class="fmap"><b>T</b>=OD <b>I</b>=drum <b>M</b>=bass <b>R</b>=pad <b>P</b>=tex</div>
      <div class="hud-bar"><div class="hud-bar-fill fill-a" id="hr-b"></div></div>
    </div>
    <div class="hud-s" id="hud-c" style="display:none">
      <div class="hud-label">Combined</div>
      <div class="hud-row">Spread: <span id="h-sp">-</span>
        <span class="gt" id="gt-orb">orb</span><span class="gt" id="gt-frz">freeze</span></div>
    </div>
    <div class="hud-s">
      <div class="hud-label">Scene</div>
      <div class="hud-row"><span id="h-scene">Dark DnB</span></div>
    </div>
  </div>
  <div id="instructions">Snap to freeze time &bull; Orb between hands → slam to change song &bull; Fingers = tracks &bull; Grab artifacts</div>

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3/camera_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4/hands.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/tone@14.7.77/build/Tone.js" crossorigin="anonymous"></script>
  <script type="importmap">{"imports":{"three":"https://cdn.jsdelivr.net/npm/three@0.162.0/build/three.module.js","three/addons/":"https://cdn.jsdelivr.net/npm/three@0.162.0/examples/jsm/"}}</script>

  <script type="module">
    import * as THREE from 'three';
    import{EffectComposer}from'three/addons/postprocessing/EffectComposer.js';
    import{RenderPass}from'three/addons/postprocessing/RenderPass.js';
    import{UnrealBloomPass}from'three/addons/postprocessing/UnrealBloomPass.js';
    import{ShaderPass}from'three/addons/postprocessing/ShaderPass.js';

    /* ===== GLSL ===== */
    const NOISE=`vec3 mod289(vec3 x){return x-floor(x/289.)*289.;}vec4 mod289(vec4 x){return x-floor(x/289.)*289.;}vec4 permute(vec4 x){return mod289(((x*34.)+1.)*x);}vec4 taylorInvSqrt(vec4 r){return 1.79284291400159-.85373472095314*r;}float snoise(vec3 v){const vec2 C=vec2(1./6.,1./3.);const vec4 D=vec4(0.,.5,1.,2.);vec3 i=floor(v+dot(v,C.yyy));vec3 x0=v-i+dot(i,C.xxx);vec3 g=step(x0.yzx,x0.xyz);vec3 l=1.-g;vec3 i1=min(g.xyz,l.zxy);vec3 i2=max(g.xyz,l.zxy);vec3 x1=x0-i1+C.xxx;vec3 x2=x0-i2+C.yyy;vec3 x3=x0-D.yyy;i=mod289(i);vec4 p=permute(permute(permute(i.z+vec4(0.,i1.z,i2.z,1.))+i.y+vec4(0.,i1.y,i2.y,1.))+i.x+vec4(0.,i1.x,i2.x,1.));float n_=.142857142857;vec3 ns=n_*D.wyz-D.xzx;vec4 j=p-49.*floor(p*ns.z*ns.z);vec4 x_=floor(j*ns.z);vec4 y_=floor(j-7.*x_);vec4 x=x_*ns.x+ns.yyyy;vec4 y=y_*ns.x+ns.yyyy;vec4 h=1.-abs(x)-abs(y);vec4 b0=vec4(x.xy,y.xy);vec4 b1=vec4(x.zw,y.zw);vec4 s0=floor(b0)*2.+1.;vec4 s1=floor(b1)*2.+1.;vec4 sh=-step(h,vec4(0.));vec4 a0=b0.xzyw+s0.xzyw*sh.xxyy;vec4 a1=b1.xzyw+s1.xzyw*sh.zzww;vec3 p0=vec3(a0.xy,h.x);vec3 p1=vec3(a0.zw,h.y);vec3 p2=vec3(a1.xy,h.z);vec3 p3=vec3(a1.zw,h.w);vec4 norm=taylorInvSqrt(vec4(dot(p0,p0),dot(p1,p1),dot(p2,p2),dot(p3,p3)));p0*=norm.x;p1*=norm.y;p2*=norm.z;p3*=norm.w;vec4 m=max(.6-vec4(dot(x0,x0),dot(x1,x1),dot(x2,x2),dot(x3,x3)),0.);m=m*m;return 42.*dot(m*m,vec4(dot(p0,x0),dot(p1,x1),dot(p2,x2),dot(p3,x3)));}`;
    const CORE_V=`${NOISE}uniform float uTime,uOpenness,uBass;varying vec3 vNormal,vWP;varying float vD;void main(){vNormal=normalize(normalMatrix*normal);float n1=snoise(position*1.8+uTime*.25);float n2=snoise(position*3.5+uTime*.5)*.5;float d=(n1+n2)*uOpenness*.4+uBass*.22;vD=d;vec3 np=position+normal*d;vWP=(modelMatrix*vec4(np,1.)).xyz;gl_Position=projectionMatrix*modelViewMatrix*vec4(np,1.);}`;
    const CORE_F=`uniform float uTime,uOpenness,uHighs;uniform vec3 uC1,uC2,uC3;varying vec3 vNormal,vWP;varying float vD;void main(){vec3 vd=normalize(cameraPosition-vWP);float f=pow(1.-abs(dot(normalize(vNormal),vd)),2.5);vec3 base=mix(uC1,uC2,uOpenness);vec3 col=mix(base,uC3,f*.55);col+=vec3(.08,.15,.12)*smoothstep(0.,.3,vD);col+=uHighs*f*vec3(.4,.7,1.);gl_FragColor=vec4(col*(.35+uOpenness*.65),.94);}`;
    const FX={
      uniforms:{tDiffuse:{value:null},uTime:{value:0},uI:{value:0},uW:{value:0},
        uWarp:{value:0},uWarpPos:{value:new THREE.Vector2(.5,.5)},uSnap:{value:0},uFreeze:{value:0}},
      vertexShader:`varying vec2 vUv;void main(){vUv=uv;gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.);}`,
      fragmentShader:`uniform sampler2D tDiffuse;uniform float uTime,uI,uW,uWarp,uSnap,uFreeze;uniform vec2 uWarpPos;varying vec2 vUv;
        void main(){
          vec2 c=vUv-.5;
          vec2 uv=vUv+c*length(c)*uW*.18;

          // Gravitational lens warp (subtle, localized)
          vec2 toCenter=uWarpPos-vUv;
          float td=length(toCenter);
          float warpR=.06+uWarp*.12;
          float pull=smoothstep(warpR*2.,0.,td)*uWarp;
          // Gentle pull toward warp point
          uv+=normalize(toCenter+.0001)*pull*.04;
          // Very subtle twist
          float angle=pull*.8;
          vec2 d=uv-uWarpPos;
          uv=uWarpPos+vec2(d.x*cos(angle)-d.y*sin(angle),d.x*sin(angle)+d.y*cos(angle));
          // Snap ripple — expanding ring on release
          float snapRing=smoothstep(.025,0.,abs(td-(1.-uSnap)*.6))*uSnap*.7;

          // Chromatic aberration — amplified near warp
          float ab=.002+uI*.006+uW*.004+pull*.015+uSnap*.02;
          float r=texture2D(tDiffuse,uv+vec2(ab,0.)).r;
          float g=texture2D(tDiffuse,uv).g;
          float b=texture2D(tDiffuse,uv-vec2(ab,0.)).b;
          vec3 col=vec3(r,g,b);
          // Event horizon glow
          float edgeGlow=smoothstep(warpR*.8,warpR*.2,td)*uWarp;
          col+=vec3(.05,.6,.9)*edgeGlow*.5;
          col+=vec3(.0,.8,1.)*snapRing;
          // Darken core of warp (black hole center)
          col*=1.-smoothstep(warpR*.6,0.,td)*uWarp*.6;
          // Time freeze: desaturate + blue tint
          float grey=dot(col,vec3(.299,.587,.114));
          col=mix(col,vec3(grey*.6,grey*.7,grey*1.2),uFreeze*.8);
          col+=vec3(0.,.02,.08)*uFreeze;
          // Vignette + grain
          col*=mix(.25,1.,smoothstep(.8,.25,length(vUv-.5)*1.4));
          col+=(fract(sin(dot(vUv*(uTime*60.+1.),vec2(12.9898,78.233)))*43758.5453)-.5)*.04;
          gl_FragColor=vec4(col,1.);}`,
    };

    /* ===== CFG ===== */
    const C={sm:.09,psm:.07,fsm:.15,tsm:.08,vsm:.12,parts:800,bpm:174,fMin:80,fMax:8000};
    const HC=[[0,1],[1,2],[2,3],[3,4],[0,5],[5,6],[6,7],[7,8],[5,9],[9,10],[10,11],[11,12],[9,13],[13,14],[14,15],[15,16],[13,17],[0,17],[17,18],[18,19],[19,20]];

    /* ===== STATE ===== */
    function mkH(){return{det:false,op:0,sm:0,f:0,sf:0,fs:{thumb:false,index:false,middle:false,ring:false,pinky:false},tw:.5,stw:.5,rv:0,sv:0,pd:1,pa:false,st:0,pos:{x:.5,y:.5},sp:{x:.5,y:.5},pp:{x:.5,y:.5},lm:null,lost:99,prevOp:0,odelta:0,
      snapArm:false,prevMidY:0,snapCD:0,snapped:false};}
    const S={L:mkH(),R:mkH(),ab:{bass:0,mids:0,highs:0},tOn:false,burst:0,warp:0,nova:0,hd:0,shd:0,lastNova:0,
      grav:{intensity:0,pos:{x:.5,y:.5},snap:0},aPinch:{intensity:0,snap:0},
      freeze:{active:false,timer:0,amount:0},
      orb:{active:false,size:0,pos:{x:.5,y:.5,z:2},prevDist:0,detonated:false},
      sceneIdx:0,sceneBpm:174};

    /* ===== DOM ===== */
    const $=id=>document.getElementById(id);
    const hCtx=$('hand-canvas').getContext('2d');

    /* ===== UTIL ===== */
    const lerp=(a,b,t)=>a+(b-a)*t,clamp=(v,l=0,h=1)=>Math.max(l,Math.min(h,v));
    const dst=(a,b)=>Math.sqrt((a.x-b.x)**2+(a.y-b.y)**2+((a.z||0)-(b.z||0))**2);
    function showErr(m){$('loading-msg').style.display='none';$('error-text').textContent=m;$('error-msg').style.display='flex';}
    function calcOp(lm){const h=dst(lm[0],lm[9]);if(h<.001)return 0;let a=0;for(const i of[8,12,16,20])a+=dst(lm[i],lm[0]);return clamp((a/4/h-1.2)/1.3);}
    function getFS(lm){const w=lm[0];return{thumb:dst(lm[4],lm[5])>dst(lm[3],lm[5])*1.1,index:dst(lm[8],w)>dst(lm[6],w)*1.05,middle:dst(lm[12],w)>dst(lm[10],w)*1.05,ring:dst(lm[16],w)>dst(lm[14],w)*1.05,pinky:dst(lm[20],w)>dst(lm[18],w)*1.05};}
    function calcTw(lm){const h=dst(lm[0],lm[9]);if(h<.001)return .5;return clamp((lm[20].y-lm[4].y)/h*.8+.5);}
    function palmC(lm){let x=0,y=0;for(const i of[0,5,9,13,17]){x+=lm[i].x;y+=lm[i].y;}return{x:x/5,y:y/5};}

    /* ===== THREE ===== */
    let scene,cam,ren,comp,bloom,fxP,coreObj,cU,shardG,gridMesh,particles,pPos,pD,ptL,clock,vidTex,vidBGMat,orbMesh,orbGlow;
    const rings=[],shockwaves=[],artifacts=[];

    function initThree(){
      clock=new THREE.Clock();scene=new THREE.Scene();
      cam=new THREE.PerspectiveCamera(60,innerWidth/innerHeight,.1,100);cam.position.set(0,.3,5.5);
      ren=new THREE.WebGLRenderer({canvas:$('three-canvas'),antialias:true});
      ren.setSize(innerWidth,innerHeight);ren.setPixelRatio(Math.min(devicePixelRatio,2));
      ren.toneMapping=THREE.ACESFilmicToneMapping;ren.toneMappingExposure=1.2;

      // Webcam as in-scene background plane
      vidTex=new THREE.VideoTexture($('webcam'));vidTex.minFilter=THREE.LinearFilter;
      vidBGMat=new THREE.ShaderMaterial({
        uniforms:{tVid:{value:vidTex},uBass:{value:0},uNova:{value:0},uTime:{value:0}},
        vertexShader:`varying vec2 vUv;void main(){vUv=uv;gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.);}`,
        fragmentShader:`uniform sampler2D tVid;uniform float uBass,uNova,uTime;varying vec2 vUv;void main(){
          vec2 uv=vec2(1.-vUv.x,vUv.y);
          uv+=(uv-.5)*uBass*.02;
          vec3 col=texture2D(tVid,uv).rgb;
          col*=.35+uBass*.08+uNova*.15;
          col=mix(col,col*vec3(.6,.8,1.),.4);
          gl_FragColor=vec4(col,1.);}`,
        depthWrite:false,side:THREE.DoubleSide
      });
      const bgPlane=new THREE.Mesh(new THREE.PlaneGeometry(120,90),vidBGMat);
      bgPlane.position.z=-45;bgPlane.renderOrder=-1;scene.add(bgPlane);

      comp=new EffectComposer(ren);
      comp.addPass(new RenderPass(scene,cam));
      bloom=new UnrealBloomPass(new THREE.Vector2(innerWidth,innerHeight),.8,.4,.92);comp.addPass(bloom);
      fxP=new ShaderPass(FX);comp.addPass(fxP);

      scene.add(new THREE.AmbientLight(0x111133,.4));
      ptL=new THREE.PointLight(0x00ffd5,2,20);ptL.position.set(0,2,4);scene.add(ptL);
      const rim=new THREE.PointLight(0x7b61ff,1.5,15);rim.position.set(-3,-1,-2);scene.add(rim);

      // Core
      cU={uTime:{value:0},uOpenness:{value:0},uBass:{value:0},uHighs:{value:0},uC1:{value:new THREE.Color(0x1a0a3e)},uC2:{value:new THREE.Color(0x00ffd5)},uC3:{value:new THREE.Color(0xff6b9d)}};
      coreObj=new THREE.Mesh(new THREE.IcosahedronGeometry(1,4),new THREE.ShaderMaterial({vertexShader:CORE_V,fragmentShader:CORE_F,uniforms:cU,transparent:true,side:THREE.DoubleSide}));
      coreObj.scale.set(0,0,0);scene.add(coreObj);
      coreObj.add(new THREE.Mesh(new THREE.IcosahedronGeometry(.82,2),new THREE.MeshBasicMaterial({color:0x00ffd5,transparent:true,opacity:.1})));

      // 3 Rings
      for(let i=0;i<3;i++){
        const r=new THREE.Mesh(new THREE.TorusGeometry(1.6+i*.5,.012,16,100),new THREE.MeshBasicMaterial({color:0x00ffd5,transparent:true,opacity:0,wireframe:true}));
        r.rotation.x=Math.PI*(.25+i*.18);r.rotation.z=i*1.1;scene.add(r);rings.push(r);
      }

      // Shards
      shardG=new THREE.Group();
      for(let i=0;i<8;i++){
        const m=new THREE.Mesh(new THREE.OctahedronGeometry(.12,0),new THREE.MeshStandardMaterial({color:0x7b61ff,emissive:0x7b61ff,emissiveIntensity:.25,metalness:.8,roughness:.2,transparent:true,opacity:0}));
        m.userData={a:(i/8)*Math.PI*2,spd:.4+Math.random()*.3,yO:(Math.random()-.5)*1.2,rad:2.2+Math.random()*.8};
        shardG.add(m);
      }scene.add(shardG);

      // Grid floor
      const gg=new THREE.PlaneGeometry(30,30,30,30);
      gridMesh=new THREE.Mesh(gg,new THREE.MeshBasicMaterial({color:0x00ffd5,wireframe:true,transparent:true,opacity:.03}));
      gridMesh.rotation.x=-Math.PI/2;gridMesh.position.y=-3;scene.add(gridMesh);

      // Shockwaves
      for(let i=0;i<8;i++){
        const sw=new THREE.Mesh(new THREE.RingGeometry(.1,.22,32),new THREE.MeshBasicMaterial({color:0x00ffd5,transparent:true,opacity:0,side:THREE.DoubleSide}));
        sw.userData={on:false,life:0};scene.add(sw);shockwaves.push(sw);
      }

      // Grabbable artifacts
      const artGeos=[new THREE.IcosahedronGeometry(.15,1),new THREE.OctahedronGeometry(.15,0),new THREE.TetrahedronGeometry(.18,0),new THREE.DodecahedronGeometry(.13,0)];
      const artCols=[0x00ffd5,0x7b61ff,0xff6b9d,0xffaa40,0x40ffaa,0x6b9dff];
      for(let i=0;i<6;i++){
        const gc=artCols[i],geo=artGeos[i%artGeos.length];
        const m=new THREE.Mesh(geo,new THREE.MeshStandardMaterial({color:gc,emissive:gc,emissiveIntensity:.15,metalness:.9,roughness:.1,transparent:true,opacity:.75}));
        const a=Math.random()*Math.PI*2,r=2.5+Math.random()*2;
        m.position.set(Math.cos(a)*r,(Math.random()-.5)*2.5,Math.sin(a)*r);
        m.userData={
          home:m.position.clone(),drift:{a,r,yOff:m.position.y,spd:.2+Math.random()*.3},
          grabbed:false,grabbedBy:null,vel:new THREE.Vector3(),
          highlight:0,thrown:false,throwLife:0
        };
        scene.add(m);artifacts.push(m);
      }

      // Energy orb (hidden until active)
      orbMesh=new THREE.Mesh(new THREE.IcosahedronGeometry(.5,3),new THREE.MeshBasicMaterial({color:0xffffff,transparent:true,opacity:0}));
      orbGlow=new THREE.Mesh(new THREE.IcosahedronGeometry(.65,2),new THREE.MeshBasicMaterial({color:0x00ffd5,transparent:true,opacity:0,wireframe:true}));
      orbMesh.add(orbGlow);scene.add(orbMesh);orbMesh.visible=false;

      initParts();
      window.addEventListener('resize',()=>{cam.aspect=innerWidth/innerHeight;cam.updateProjectionMatrix();ren.setSize(innerWidth,innerHeight);comp.setSize(innerWidth,innerHeight);const hc=$('hand-canvas');hc.width=innerWidth;hc.height=innerHeight;});
    }

    function initParts(){
      const N=C.parts,g=new THREE.BufferGeometry();pPos=new Float32Array(N*3);const cols=new Float32Array(N*3);pD=[];
      for(let i=0;i<N;i++){
        const t=Math.random()*Math.PI*2,p=Math.acos(2*Math.random()-1),r=1.5+Math.random()*2.8;
        pPos[i*3]=r*Math.sin(p)*Math.cos(t);pPos[i*3+1]=r*Math.sin(p)*Math.sin(t);pPos[i*3+2]=r*Math.cos(p);
        cols[i*3]=.08;cols[i*3+1]=.2;cols[i*3+2]=.4;
        pD.push({bR:r,th:t,ph:p,spd:.002+Math.random()*.01,off:Math.random()*Math.PI*2});
      }
      g.setAttribute('position',new THREE.BufferAttribute(pPos,3));g.setAttribute('color',new THREE.BufferAttribute(cols,3));
      particles=new THREE.Points(g,new THREE.PointsMaterial({size:.025,vertexColors:true,transparent:true,opacity:.5,blending:THREE.AdditiveBlending,depthWrite:false}));
      scene.add(particles);
    }

    function fireSW(col){const s=shockwaves.find(s=>!s.userData.on);if(!s)return;s.userData.on=true;s.userData.life=1;s.scale.set(.3,.3,.3);s.material.color.set(col||0x00ffd5);}

    /* ===== SCENES ===== */
    const SCENES=[
      {name:'Dark DnB',bpm:174,
        pads:[['D3','A3','D4','F4'],['Bb2','F3','Bb3','D4'],['G2','D3','G3','Bb3'],['A2','E3','A3','C#4']],
        bass:['D1',null,null,null,null,null,'D1',null,'D2',null,null,null,null,'D1',null,null,
              'Bb1',null,null,null,null,null,'Bb1',null,'Bb1',null,null,null,null,'Bb1',null,null,
              'G1',null,null,null,null,null,'G1',null,'G1',null,null,null,null,'G2',null,null,
              'A1',null,null,null,null,null,'A1',null,'A1',null,null,null,null,null,'A2',null],
        kick:[1,0,0,0,0,0,.8,0,1,0,0,.5,0,0,0,0,1,0,0,0,0,0,0,.7,0,0,1,0,0,0,.6,0],
        snr:[0,0,0,0,1,0,0,.3,0,0,1,0,0,.3,.8,0,0,0,0,0,1,0,0,0,0,.4,1,0,0,0,1,.5],
        hh:[1,0,.5,0,1,0,.5,.3,1,0,.5,0,1,0,.5,.3,1,0,.5,.2,1,0,.5,0,1,.3,.5,0,1,0,.5,.4],
        tex:['D3','Bb2','G2','A2']},
      {name:'Half-time',bpm:87,
        pads:[['F3','Ab3','C4','F4'],['Db3','F3','Ab3','Db4'],['Ab2','Eb3','Ab3','C4'],['Eb3','G3','Bb3','Eb4']],
        bass:['F1',null,null,null,null,null,null,null,'F1',null,null,null,null,null,null,null,
              'Db1',null,null,null,null,null,null,null,'Db1',null,null,null,null,null,null,null,
              'Ab1',null,null,null,null,null,null,null,'Ab1',null,null,null,null,null,null,null,
              'Eb1',null,null,null,null,null,null,null,'Eb1',null,null,null,null,null,'Eb2',null],
        kick:[1,0,0,0,0,0,0,0,0,0,0,0,0,0,.6,0,1,0,0,0,0,0,0,0,0,0,0,0,.5,0,0,0],
        snr:[0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,.3,1,0,0,0,0,0,0,0],
        hh:[0,.5,0,.3,0,.5,0,.3,0,.5,0,.3,0,.5,0,.5,0,.5,0,.3,0,.5,0,.3,0,.5,0,.5,0,.5,.3,.5],
        tex:['F3','Db3','Ab2','Eb3']},
      {name:'Jungle',bpm:174,
        pads:[['G3','Bb3','D4','G4'],['Eb3','G3','Bb3','Eb4'],['C3','Eb3','G3','C4'],['D3','F#3','A3','D4']],
        bass:['G1',null,'G1',null,null,null,'G2',null,'G1',null,null,'G1',null,null,'G1',null,
              'Eb1',null,'Eb1',null,null,null,'Eb2',null,'Eb1',null,null,'Eb1',null,null,'Eb1',null,
              'C1',null,'C1',null,null,null,'C2',null,'C1',null,'C1',null,null,null,'C1',null,
              'D1',null,'D1',null,null,'D2',null,null,'D1',null,'D1',null,null,'D2',null,null],
        kick:[1,0,0,.5,0,0,1,0,0,0,1,0,0,0,.7,0,1,0,0,0,0,.6,1,0,0,0,1,0,.5,0,0,0],
        snr:[0,0,0,0,1,0,.4,0,0,.3,1,0,0,0,.5,.3,0,0,0,0,1,0,0,.4,0,.5,1,0,0,.3,.7,0],
        hh:[1,.3,.5,.3,1,.3,.5,.5,1,.3,.5,.3,1,.5,.5,.3,1,.3,.5,.3,1,.3,.5,.5,1,.5,.5,.3,1,.3,.5,.5],
        tex:['G3','Eb3','C3','D3']},
      {name:'Ambient',bpm:87,
        pads:[['A3','C4','E4','A4'],['F3','A3','C4','F4'],['G3','B3','D4','G4'],['E3','G3','B3','E4']],
        bass:['A1',null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,
              'F1',null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,
              'G1',null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,
              'E1',null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],
        kick:[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        snr:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],
        hh:[0,0,0,0,0,0,.3,0,0,0,0,0,0,0,.3,0,0,0,0,0,0,0,.3,0,0,0,0,0,0,0,.3,0],
        tex:['A2','F2','G2','E2']},
    ];

    /* ===== AUDIO ===== */
    let fft,mFilt,mPhas,mRev,mGain,stut,mDist;
    const lG={},seqs=[];
    let padSeq,basSeq,kS,sS,hS,texSeq,padS,texS;

    function initAudio(){
      const sc=SCENES[0];
      Tone.Transport.bpm.value=sc.bpm;S.sceneBpm=sc.bpm;
      mGain=new Tone.Gain(0);mRev=new Tone.Reverb({decay:3,wet:.25});
      mPhas=new Tone.Phaser({frequency:.6,octaves:3,baseFrequency:400,wet:0});
      mFilt=new Tone.Filter({frequency:C.fMax,type:'lowpass',rolloff:-24,Q:1});
      mDist=new Tone.Distortion({distortion:.7,wet:0,oversample:'2x'});
      stut=new Tone.Tremolo({frequency:8,depth:0,type:'square',spread:0}).start();
      stut.connect(mDist);mDist.connect(mFilt);mFilt.connect(mPhas);mPhas.connect(mRev);mRev.connect(mGain);mGain.toDestination();
      fft=new Tone.FFT(32);mGain.connect(fft);

      for(const n of['drums','bass','pad','tex'])lG[n]=new Tone.Gain(0).connect(stut);

      padS=new Tone.PolySynth(Tone.Synth,{oscillator:{type:'fatsawtooth',spread:30,count:3},envelope:{attack:1.5,decay:1,sustain:.6,release:2},volume:-14}).connect(lG.pad);
      padSeq=new Tone.Sequence((t,ch)=>{padS.releaseAll(t);padS.triggerAttack(ch,t+.05);},sc.pads,'1m');
      padSeq.loop=true;seqs.push(padSeq);

      const basS_=new Tone.MonoSynth({oscillator:{type:'fatsawtooth',spread:20,count:3},filter:{Q:3,type:'lowpass',rolloff:-24},filterEnvelope:{attack:.04,decay:.25,sustain:.5,release:.4,baseFrequency:50,octaves:3},envelope:{attack:.02,decay:.1,sustain:.8,release:.25},volume:-5}).connect(lG.bass);
      basSeq=new Tone.Sequence((t,n)=>{if(n)basS_.triggerAttackRelease(n,'8n',t);},sc.bass,'16n');
      basSeq.loop=true;seqs.push(basSeq);

      const kick=new Tone.MembraneSynth({pitchDecay:.03,octaves:8,oscillator:{type:'sine'},envelope:{attack:.001,decay:.18,sustain:0,release:.15},volume:-2}).connect(lG.drums);
      const snare=new Tone.NoiseSynth({noise:{type:'white'},envelope:{attack:.001,decay:.1,sustain:0,release:.06},volume:-6}).connect(lG.drums);
      const hh=new Tone.MetalSynth({frequency:400,envelope:{attack:.001,decay:.035,release:.008},harmonicity:5.1,modulationIndex:40,resonance:5000,octaves:1.5,volume:-14}).connect(lG.drums);
      kS=new Tone.Sequence((t,v)=>{if(v)kick.triggerAttackRelease('C1','16n',t,v);},sc.kick,'16n');
      sS=new Tone.Sequence((t,v)=>{if(v)snare.triggerAttackRelease('16n',t,v);},sc.snr,'16n');
      hS=new Tone.Sequence((t,v)=>{if(v)hh.triggerAttackRelease('C6','32n',t,v);},sc.hh,'16n');
      kS.loop=sS.loop=hS.loop=true;seqs.push(kS,sS,hS);

      texS=new Tone.MonoSynth({oscillator:{type:'fatsawtooth',spread:50,count:4},filter:{Q:1.5,type:'lowpass',rolloff:-24},filterEnvelope:{attack:1.5,decay:1,sustain:.3,release:2.5,baseFrequency:60,octaves:2},envelope:{attack:1,decay:.5,sustain:.7,release:2.5},volume:-10}).connect(lG.tex);
      // One note per bar from tex array, padded to 16n over 4 bars
      const mkTex=a=>{const o=[];for(const n of a){o.push(n);for(let i=0;i<15;i++)o.push(null);}return o;};
      texSeq=new Tone.Sequence((t,n)=>{if(n)texS.triggerAttackRelease(n,'1m',t);},mkTex(sc.tex),'16n');
      texSeq.loop=true;seqs.push(texSeq);
    }

    function switchScene(idx){
      const sc=SCENES[idx];S.sceneIdx=idx;S.sceneBpm=sc.bpm;
      Tone.Transport.bpm.rampTo(sc.bpm,.8);
      padSeq.events=sc.pads;basSeq.events=sc.bass;
      kS.events=sc.kick;sS.events=sc.snr;hS.events=sc.hh;
      const mkTex=a=>{const o=[];for(const n of a){o.push(n);for(let i=0;i<15;i++)o.push(null);}return o;};
      texSeq.events=mkTex(sc.tex);
    }

    function trigGravSnap(intensity){
      S.grav.snap=1;S.burst=Math.max(S.burst,1.5);S.warp=Math.max(S.warp,.3+intensity*.3);
      fireSW(0x00ffd5);fireSW(0x7b61ff);
    }
    function trigAudioSnap(intensity){
      S.aPinch.snap=1;
      // Impact: slam filter down then sweep back up
      if(mFilt){mFilt.frequency.cancelScheduledValues(Tone.now());
        mFilt.frequency.setValueAtTime(80,Tone.now());
        mFilt.frequency.rampTo(C.fMax,.6);
        mFilt.Q.setValueAtTime(15,Tone.now());
        mFilt.Q.rampTo(1,.5);}
    }

    function startT(){if(S.tOn)return;S.tOn=true;seqs.forEach(s=>s.start(0));Tone.Transport.start();mGain.gain.rampTo(1,1);}
    function stopT(){if(!S.tOn)return;S.tOn=false;mGain.gain.rampTo(0,1.5);setTimeout(()=>{if(!S.tOn){Tone.Transport.stop();seqs.forEach(s=>s.stop());}},2000);}
    function getBands(){const v=fft.getValue();const nm=(s,c)=>clamp((s/c+80)/70);let b=0,m=0,h=0;for(let i=0;i<3;i++)b+=v[i];for(let i=3;i<10;i++)m+=v[i];for(let i=10;i<32;i++)h+=v[i];return{bass:nm(b,3),mids:nm(m,7),highs:nm(h,22)};}

    /* ===== HAND TRACKING ===== */
    let mpH,mpC;
    function initHT(){
      mpH=new Hands({locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4/${f}`});
      mpH.setOptions({maxNumHands:2,modelComplexity:1,minDetectionConfidence:.7,minTrackingConfidence:.5});
      mpH.onResults(onHR);mpC=new Camera($('webcam'),{onFrame:async()=>{await mpH.send({image:$('webcam')});},width:640,height:480});
    }

    function procH(h,lm,col){
      h.det=true;h.lost=0;h.lm=lm;h.pp.x=h.pos.x;h.pp.y=h.pos.y;
      h.prevOp=h.op;h.op=calcOp(lm);h.odelta=h.op-h.prevOp;
      h.fs=getFS(lm);h.f=Object.values(h.fs).filter(Boolean).length;
      h.tw=calcTw(lm);const p=palmC(lm);h.pos.x=1-p.x;h.pos.y=p.y;
      h.rv=Math.sqrt((h.pos.x-h.pp.x)**2+(h.pos.y-h.pp.y)**2);
      h.pd=dst(lm[4],lm[8]);if(h.pd<.05)h.pa=true;
      h.st=(h.pa&&h.pd>.05)?clamp((h.pd-.05)/.09):0;
      // Snap detection: thumb+middle close → middle shoots down
      h.snapped=false;const tmd=dst(lm[4],lm[12]);
      if(h.snapCD>0)h.snapCD--;
      if(!h.snapArm&&tmd<.06)h.snapArm=true;
      if(h.snapArm&&h.snapCD<=0){
        const midDy=lm[12].y-h.prevMidY;
        if(tmd>.1&&midDy>.03){h.snapped=true;h.snapArm=false;h.snapCD=20;}
        else if(tmd>.12)h.snapArm=false;
      }
      h.prevMidY=lm[12].y;
      drawH(lm,col);if(h.pa&&h.st>0)drawStr(lm,h.st,col);
    }

    function lostH(h){h.lost++;if(h.lost>15){h.det=false;h.op=0;h.f=0;h.rv=0;h.pa=false;h.st=0;}}

    function onHR(res){
      const hc=$('hand-canvas');
      if(hc.width!==innerWidth||hc.height!==innerHeight){hc.width=innerWidth;hc.height=innerHeight;}
      hCtx.clearRect(0,0,hc.width,hc.height);
      const det=[];
      if(res.multiHandLandmarks)for(let i=0;i<res.multiHandLandmarks.length;i++){const lm=res.multiHandLandmarks[i],p=palmC(lm);det.push({lm,mx:1-p.x});}
      let ls=false,rs=false;
      if(det.length>=2){det.sort((a,b)=>a.mx-b.mx);procH(S.L,det[0].lm,'#00ffd5');procH(S.R,det[1].lm,'#ff6b9d');ls=rs=true;}
      else if(det.length===1){if(det[0].mx<.5){procH(S.L,det[0].lm,'#00ffd5');ls=true;}else{procH(S.R,det[0].lm,'#ff6b9d');rs=true;}}
      if(!ls)lostH(S.L);if(!rs)lostH(S.R);
    }

    function drawH(lm,col){
      const w=innerWidth,h=innerHeight;
      hCtx.strokeStyle=col+'40';hCtx.lineWidth=1.5;
      for(const[a,b]of HC){hCtx.beginPath();hCtx.moveTo((1-lm[a].x)*w,lm[a].y*h);hCtx.lineTo((1-lm[b].x)*w,lm[b].y*h);hCtx.stroke();}
      for(let i=0;i<lm.length;i++){const t=[4,8,12,16,20].includes(i);hCtx.beginPath();hCtx.arc((1-lm[i].x)*w,lm[i].y*h,t?4:2.5,0,Math.PI*2);hCtx.fillStyle=t?col:'rgba(255,255,255,.4)';hCtx.fill();}
    }

    function drawStr(lm,ten,col){
      const w=innerWidth,h=innerHeight;
      hCtx.save();const mx=(lm[4].x+lm[8].x)/2,my=(lm[4].y+lm[8].y)/2;
      const vib=Math.sin(Date.now()*.03)*ten*.02;
      hCtx.beginPath();hCtx.moveTo((1-lm[4].x)*w,lm[4].y*h);
      hCtx.quadraticCurveTo((1-mx)*w,(my+vib)*h,(1-lm[8].x)*w,lm[8].y*h);
      hCtx.strokeStyle=col;hCtx.lineWidth=1+ten*4;hCtx.shadowColor=col;hCtx.shadowBlur=ten*20;
      hCtx.globalAlpha=.4+ten*.6;hCtx.stroke();hCtx.restore();
    }

    /* ===== ANIMATE ===== */
    function animate(){
      requestAnimationFrame(animate);const el=clock.getElapsedTime();

      for(const h of[S.L,S.R]){
        h.sm=lerp(h.sm,h.op,C.sm);h.sf=lerp(h.sf,h.f,C.fsm);
        h.stw=lerp(h.stw,h.tw,C.tsm);h.sv=lerp(h.sv,h.rv,C.vsm);
        h.sp.x=lerp(h.sp.x,h.pos.x,C.psm);h.sp.y=lerp(h.sp.y,h.pos.y,C.psm);
      }

      if(S.tOn){const ab=getBands();S.ab.bass=lerp(S.ab.bass,ab.bass,.2);S.ab.mids=lerp(S.ab.mids,ab.mids,.2);S.ab.highs=lerp(S.ab.highs,ab.highs,.2);}
      if(S.L.det&&S.R.det){const dx=S.L.sp.x-S.R.sp.x,dy=S.L.sp.y-S.R.sp.y;S.hd=Math.sqrt(dx*dx+dy*dy);}else S.hd=0;
      S.shd=lerp(S.shd,S.hd,.06);

      const L=S.L,R=S.R,lo=L.sm,lf=L.sf,ro=R.sm;
      const{bass,mids,highs}=S.ab;

      // Decays
      S.burst*=.9;S.warp*=.91;S.nova*=.93;
      if(L.sv>.02)S.burst=Math.max(S.burst,L.sv*10);

      // Supernova: rapid open on left hand
      if(L.det&&L.odelta>.25&&el-S.lastNova>1.5){
        S.lastNova=el;S.nova=1;S.burst=2;S.warp=.8;
        fireSW(0xffffff);fireSW(0x00ffd5);fireSW(0x7b61ff);
      }

      // Snap → toggle time freeze (either hand)
      for(const h of[L,R]){
        if(h.snapped){
          S.freeze.active=!S.freeze.active;
          if(S.freeze.active){if(S.tOn)Tone.Transport.bpm.rampTo(30,.3);}
          else{if(S.tOn)Tone.Transport.bpm.rampTo(S.sceneBpm,.4);}
          fireSW(S.freeze.active?0x8888ff:0xffffff);
        }
      }
      S.freeze.amount=lerp(S.freeze.amount,S.freeze.active?1:0,S.freeze.active?.15:.08);

      // Left pinch → gravitational lens (visual)
      if(L.pa&&L.pd>.14){trigGravSnap(L.st);L.pa=false;}
      if(L.pa&&L.st>0){S.grav.intensity=Math.max(S.grav.intensity,L.st);S.grav.pos.x=L.sp.x;S.grav.pos.y=L.sp.y;}
      else S.grav.intensity*=.85;
      S.grav.snap*=.9;
      // Right pinch → audio tension riser
      if(R.pa&&R.pd>.14){trigAudioSnap(R.st);R.pa=false;}
      if(R.pa&&R.st>0){
        S.aPinch.intensity=R.st;
        // Build tension: sweep filter down + raise resonance
        if(S.tOn){const tf=C.fMax-(C.fMax-200)*R.st;mFilt.frequency.rampTo(tf,.05);mFilt.Q.rampTo(1+R.st*18,.05);}
      }else{S.aPinch.intensity*=.85;}
      S.aPinch.snap*=.9;

      /* ======= ENERGY ORB ======= */
      if(L.det&&R.det){
        const hRaw=S.hd;const orbThresh=.35;
        const closing=S.orb.prevDist-hRaw;// positive = getting closer
        if(hRaw<orbThresh&&hRaw>.08){
          S.orb.active=true;S.orb.size=lerp(S.orb.size,hRaw*3,.1);
          S.orb.pos.x=(L.sp.x+R.sp.x)/2;S.orb.pos.y=(L.sp.y+R.sp.y)/2;
          orbMesh.visible=true;
          orbMesh.position.set((S.orb.pos.x-.5)*8,(.5-S.orb.pos.y)*5,2);
          const os=S.orb.size*.6;orbMesh.scale.set(os,os,os);
          orbMesh.material.opacity=lerp(orbMesh.material.opacity,.7,.1);
          orbMesh.material.color.setHSL((el*.1)%1,.8,.7);
          orbGlow.material.opacity=.3+Math.sin(el*5)*.15;
          orbGlow.rotation.y+=.03;orbGlow.rotation.x+=.02;
          orbMesh.rotation.y+=.02;
        }else if(S.orb.active&&(hRaw<=.08||closing>.04)){
          // DETONATION — hands slammed together or rapid closure
          S.orb.detonated=true;S.orb.active=false;
          S.nova=1.2;S.burst=3;fireSW(0xffffff);fireSW(0x00ffd5);fireSW(0xff6b9d);fireSW(0x7b61ff);
        }else{S.orb.active=false;}
        S.orb.prevDist=hRaw;
      }else{
        // If orb was active and a hand was lost (overlap), treat as detonation
        if(S.orb.active){
          S.orb.detonated=true;S.orb.active=false;
          S.nova=1.2;S.burst=3;fireSW(0xffffff);fireSW(0x00ffd5);fireSW(0xff6b9d);fireSW(0x7b61ff);
        }
      }
      if(!S.orb.active){
        orbMesh.material.opacity=lerp(orbMesh.material.opacity,0,.1);
        if(orbMesh.material.opacity<.01)orbMesh.visible=false;
        S.orb.size=lerp(S.orb.size,0,.1);
      }
      // Orb detonation → switch scene
      if(S.orb.detonated){
        S.orb.detonated=false;
        const next=(S.sceneIdx+1)%SCENES.length;
        if(S.tOn)switchScene(next);
      }

      /* ======= ARTIFACTS ======= */
      for(const art of artifacts){
        const u=art.userData;
        // Check proximity to each hand
        for(const h of[L,R]){
          if(!h.det)continue;
          const hp=new THREE.Vector3((h.sp.x-.5)*8,(.5-h.sp.y)*5,2);
          const d=hp.distanceTo(art.position);
          if(!u.grabbed&&!u.thrown){
            // Highlight when close
            u.highlight=lerp(u.highlight,d<1.2?1:0,.1);
            // Pinch to grab (thumb+index close)
            if(d<1.2&&h.pd<.06){u.grabbed=true;u.grabbedBy=h;u.thrown=false;}
          }
          if(u.grabbed&&u.grabbedBy===h){
            if(h.pd>.1){
              // Released — check velocity for throw
              u.grabbed=false;u.grabbedBy=null;
              if(h.sv>.02){u.thrown=true;u.throwLife=1;u.vel.set((h.pos.x-h.pp.x)*40,(h.pp.y-h.pos.y)*40,0);fireSW(art.material.color.getHex());}
              break;
            }
            // Crush: fist while holding (low openness)
            if(h.op<.15&&h.f<=1){
              u.grabbed=false;u.grabbedBy=null;
              S.burst=Math.max(S.burst,1.5);fireSW(art.material.color.getHex());fireSW(0xffffff);
              // Respawn after crush
              const na=Math.random()*Math.PI*2,nr=2.5+Math.random()*2;
              art.position.set(Math.cos(na)*nr,(Math.random()-.5)*2.5,Math.sin(na)*nr);
              u.home.copy(art.position);u.drift.a=na;u.drift.r=nr;u.drift.yOff=art.position.y;
              break;
            }
            // Follow hand
            const target=new THREE.Vector3((h.sp.x-.5)*8,(.5-h.sp.y)*5,2);
            art.position.lerp(target,.15);
          }
        }
        if(u.thrown){
          u.throwLife*=.96;art.position.add(u.vel.clone().multiplyScalar(.016));u.vel.multiplyScalar(.97);
          art.rotation.x+=.15;art.rotation.z+=.1;
          art.material.emissiveIntensity=.4+u.throwLife*1.5;
          if(u.throwLife<.05){
            u.thrown=false;
            const na=Math.random()*Math.PI*2,nr=2.5+Math.random()*2;
            art.position.set(Math.cos(na)*nr,(Math.random()-.5)*2.5,Math.sin(na)*nr);
            u.home.copy(art.position);u.drift.a=na;u.drift.r=nr;u.drift.yOff=art.position.y;
          }
        }
        if(!u.grabbed&&!u.thrown){
          // Idle drift
          u.drift.a+=u.drift.spd*.005;
          const tr=u.drift.r+Math.sin(el*.3+u.drift.a)*.5;
          const tx=Math.cos(u.drift.a)*tr,tz=Math.sin(u.drift.a)*tr;
          const ty=u.drift.yOff+Math.sin(el*.5+u.drift.a*2)*.3;
          art.position.lerp(new THREE.Vector3(tx,ty,tz),.01);
          art.rotation.x+=.005;art.rotation.y+=.008;
        }
        // Visual feedback
        const hi=u.highlight;
        art.material.emissiveIntensity=lerp(art.material.emissiveIntensity,.15+hi*.5+(u.grabbed?.8:0),.1);
        const bs=u.grabbed?1.4:(1+hi*.3);art.scale.setScalar(lerp(art.scale.x,bs,.08));
      }

      /* ======= RIGHT → AUDIO ======= */
      if(R.det&&!S.tOn)startT();if(!R.det&&S.tOn)stopT();
      if(S.tOn){
        mFilt.frequency.rampTo(C.fMin+ro*(C.fMax-C.fMin),.1);
        mFilt.Q.rampTo(1+Math.abs(R.stw-.5)*22,.1);
        mPhas.wet.rampTo(.6-ro*.6,.1);

        // Thumb = distortion
        mDist.wet.rampTo(R.fs.thumb?.8:0,.15);

        // Per-finger layers: I=drum M=bass R=pad P=tex
        lG.drums.gain.rampTo(R.fs.index?1:0,.3);
        lG.bass.gain.rampTo(R.fs.middle?1:0,.3);
        lG.pad.gain.rampTo(R.fs.ring?1:0,.3);
        lG.tex.gain.rampTo(R.fs.pinky?1:0,.3);

        const sa=R.sv>.015?clamp(R.sv*18):0;
        stut.depth.rampTo(sa,.05);stut.frequency.rampTo(8+sa*16,.05);
        mRev.wet.rampTo(.1+clamp(S.shd*1.8)*.6,.2);
      }

      /* ======= LEFT → VISUALS ======= */
      const hue=L.stw;
      const c1=new THREE.Color().setHSL((.75+hue*.5)%1,.7,.15);
      const c2=new THREE.Color().setHSL((.48+hue*.5)%1,.9,.55);
      const c3=new THREE.Color().setHSL((.92+hue*.5)%1,.8,.55);
      cU.uC1.value.copy(c1);cU.uC2.value.copy(c2);cU.uC3.value.copy(c3);

      // Core
      const ts=L.det?(.15+lo*1.5+S.nova*.5):0;
      const sc=lerp(coreObj.scale.x,ts,.06);coreObj.scale.set(sc,sc,sc);
      coreObj.rotation.y+=.003+bass*.015;coreObj.rotation.x=lerp(coreObj.rotation.x,(L.sp.y-.5)*.5,.03);
      cU.uTime.value=el;cU.uOpenness.value=lo;cU.uBass.value=bass+S.nova*.3;cU.uHighs.value=highs;
      const gm=coreObj.children[0];
      if(gm){gm.material.opacity=.05+lo*.2+bass*.12+S.nova*.3;gm.material.color.copy(c2);}

      // 3 Rings (progressive: 2+, 3+, 4+ fingers)
      for(let i=0;i<3;i++){
        const r=rings[i],th=1.5+i;
        const tgt=(L.det&&lf>=th)?.5+lo*.3+S.nova*.2:0;
        r.material.opacity=lerp(r.material.opacity,tgt,.04);r.material.color.copy(c2);
        r.rotation.z+=(.003+i*.002+mids*.01)*(i%2===0?1:-1);
        const rs=.8+lo*.3+bass*.1+S.nova*.3;r.scale.set(rs,rs,rs);
      }

      // Shards (4+)
      const shT=(L.det&&lf>=3.5)?1:0;
      for(const sh of shardG.children){
        const u=sh.userData;sh.material.opacity=lerp(sh.material.opacity,shT*.8+S.nova*.3,.04);
        u.a+=u.spd*.02;const r=u.rad+Math.sin(el*.5+u.a)*.3+S.nova*1.5;
        sh.position.set(Math.cos(u.a)*r,u.yO+Math.sin(el*.8+u.a*2)*.4,Math.sin(u.a)*r);
        sh.rotation.x+=.02;sh.rotation.z+=.015;sh.material.emissive.copy(c3);
      }

      // Grid floor
      const gArr=gridMesh.geometry.attributes.position.array;
      for(let i=0;i<gArr.length;i+=3){
        gArr[i+2]=Math.sin(gArr[i]*.4+el)*.4*Math.cos(gArr[i+1]*.4+el*.7)*(bass*.8+S.nova*.5);
      }
      gridMesh.geometry.attributes.position.needsUpdate=true;
      gridMesh.material.opacity=.01+bass*.03+lo*.01+S.nova*.03;
      gridMesh.material.color.copy(c2);

      // Particles
      const pos=particles.geometry.attributes.position.array;
      const col=particles.geometry.attributes.color.array;
      const pE=L.det?(lf>=2.5?1:.4):.15;
      for(let i=0;i<C.parts;i++){
        const pd=pD[i],t=el*pd.spd+pd.off;
        const r=pd.bR*(.3+lo*.7)*pE+Math.sin(t*2)*.1+bass*.3+S.burst*1.5+S.nova*3;
        const th=pd.th+t,ph=pd.ph+Math.sin(t*.7)*.2;
        pos[i*3]=r*Math.sin(ph)*Math.cos(th);pos[i*3+1]=r*Math.sin(ph)*Math.sin(th);pos[i*3+2]=r*Math.cos(ph);
        col[i*3]=lerp(.04,c2.r,lo)*pE;col[i*3+1]=lerp(.08,c2.g,lo)*pE;col[i*3+2]=lerp(.2,c2.b,lo)*pE;
      }
      particles.geometry.attributes.position.needsUpdate=true;particles.geometry.attributes.color.needsUpdate=true;
      particles.material.opacity=.15+lo*.5*pE+mids*.15+S.nova*.4;
      particles.material.size=.02+lo*.025+highs*.015+S.nova*.04;
      particles.rotation.y+=.001;

      // Lighting
      ptL.intensity=1+lo*2.5+bass*1.8+S.nova*3;ptL.color.copy(c2);
      ptL.position.x=lerp(ptL.position.x,(L.sp.x-.5)*4,.04);
      ptL.position.y=lerp(ptL.position.y,(.5-L.sp.y)*3+1,.04);

      // Shockwaves
      for(const sw of shockwaves){if(!sw.userData.on)continue;sw.userData.life-=.018;
        if(sw.userData.life<=0){sw.userData.on=false;sw.material.opacity=0;continue;}
        const s=(1-sw.userData.life)*5.5;sw.scale.set(s,s,s);sw.material.opacity=sw.userData.life*.8;}

      bloom.strength=Math.min(.5+lo*.5+bass*.4+S.nova*1,2.2);
      fxP.uniforms.uTime.value=el;fxP.uniforms.uI.value=bass*.6+mids*.3+S.burst*.3+S.nova*.6;
      fxP.uniforms.uW.value=S.warp+S.nova*.4;
      fxP.uniforms.uWarp.value=S.grav.intensity;fxP.uniforms.uSnap.value=S.grav.snap;
      fxP.uniforms.uWarpPos.value.set(S.grav.pos.x,1-S.grav.pos.y);
      fxP.uniforms.uFreeze.value=S.freeze.amount;

      /* ======= HUD ======= */
      $('hl-s').textContent=L.det?'Tracking':'--';$('hr-s').textContent=R.det?'Tracking':'--';
      $('hl-f').textContent=L.det?Math.round(L.f):'-';
      $('hl-b').style.width=(lo*100)+'%';$('hr-b').style.width=(ro*100)+'%';
      if(R.det){const f=R.fs;$('ld-fx').className='ld'+(f.thumb?' on fx':'');$('ld-drum').className='ld'+(f.index?' on':'');$('ld-bass').className='ld'+(f.middle?' on':'');$('ld-pad').className='ld'+(f.ring?' on':'');$('ld-tex').className='ld'+(f.pinky?' on':'');}
      else for(const id of['ld-fx','ld-drum','ld-bass','ld-pad','ld-tex'])$(id).className='ld';
      $('gt-lp').className='gt'+(L.pa&&L.st>.1?' on':'');$('gt-lv').className='gt'+(L.sv>.025?' on':'');
      $('gt-nova').className='gt'+(S.nova>.3?' on':'');
      $('gt-rp').className='gt'+(R.pa&&R.st>.1?' on':'');$('gt-rv').className='gt'+(R.sv>.015?' on':'');
      const cb=$('hud-c');if(L.det&&R.det){cb.style.display='block';$('h-sp').textContent=Math.round(S.shd*100)+'%';}else cb.style.display='none';
      $('gt-orb').className='gt'+(S.orb.active?' on':'');$('gt-frz').className='gt'+(S.freeze.amount>.3?' on':'');
      $('h-scene').textContent=SCENES[S.sceneIdx].name;

      // Update webcam BG uniforms
      vidBGMat.uniforms.uBass.value=bass;vidBGMat.uniforms.uNova.value=S.nova;vidBGMat.uniforms.uTime.value=el;
      comp.render();
    }

    /* ===== START ===== */
    $('start-btn').addEventListener('click',async()=>{
      $('start-overlay').style.display='none';$('loading-msg').style.display='flex';
      try{await Tone.start();initThree();initAudio();initHT();await mpC.start();
        $('loading-msg').style.display='none';$('hud').style.display='block';
        const hc=$('hand-canvas');hc.width=innerWidth;hc.height=innerHeight;
        $('instructions').style.opacity='1';setTimeout(()=>{$('instructions').style.opacity='0';},7000);animate();
      }catch(e){console.error(e);showErr(e.name==='NotAllowedError'?'Camera access denied.':'Init failed: '+e.message+'\n\nTry Chrome via localhost.');}
    });
  </script>
</body>
</html>
